---
- name: Update apt cache (Debian)
  apt:
    update_cache: true
  become: true

- name: Ensure wget is installed (Debian)
  apt:
    pkg: wget
    state: present
  become: true

- name: Add software-properties-common (for add-apt-repository command) (Debian)
  apt:
    pkg: software-properties-common
    state: present
  become: true

- name: Ensure apt-utils is installed (Debian)
  apt:
    pkg: apt-utils
    state: present
  become: true

- name: Ensure debconf-utils is installed (Debian)
  apt:
    pkg: debconf-utils
    state: present
  become: true

- name: Set mysql_python_package
  set_fact:
    mysql_python_package: |-
      {% if 'python3' in ansible_python_interpreter | default('') -%}
      python3-mysqldb
      {%- else -%}
      python-mysqldb
      {%- endif %}

- name: Ensure mysql_python_package is installed (Debian)
  apt:
    pkg: '{{ mysql_python_package }}'
    state: present
    force: true
  become: true

- name: Install MySQL APT Repository (Debian)
  shell: "DEBIAN_FRONTEND=noninteractive dpkg -i {{ mysql_installers_path_on_target }}/{{ mysql_installer_filename }}"
  become: true

- name: Update apt cache (Debian)
  apt:
    update_cache: true
  become: true

- name: Pre-configure debconf settings (Debian)
  debconf:
    name: '{{ item.name }}'
    question: '{{ item.question }}'
    value: '{{ item.answer | quote }}'
    vtype: '{{ item.vtype }}'
  become: true
  with_items:
    - { vtype: 'select', name: 'mysql-apt-config', question: 'mysql-apt-config/unsupported-platform', answer: 'abort' }
    - { vtype: 'select', name: 'mysql-apt-config', question: 'mysql-apt-config/repo-distro', answer: 'ubuntu' }
    - { vtype: 'select', name: 'mysql-apt-config', question: 'mysql-apt-config/repo-codename', answer: "{{ mysql_repo_codename }}" }
    - { vtype: 'select', name: 'mysql-apt-config', question: 'mysql-apt-config/select-tools', answer: '' }
    - { vtype: 'select', name: 'mysql-apt-config', question: 'mysql-apt-config/select-server', answer: "mysql-{{ mysql_version_short_string }}" }
    - { vtype: 'select', name: 'mysql-apt-config', question: 'mysql-apt-config/select-product', answer: 'Apply' }
    - { vtype: 'select', name: 'mysql-apt-config', question: 'mysql-apt-config/enable-repo', answer: "mysql-{{ mysql_version_short_string }}" }
    - { vtype: 'select', name: 'mysql-community-server', question: 'mysql-server/default-auth-override', answer: 'Use Legacy Authentication Method (Retain MySQL 5.x Compatibility)' }
    - { vtype: 'password', name: 'mysql-community-server', question: 'mysql-community-server/root-pass', answer: "{{ mysql_root_password }}" }
    - { vtype: 'password', name: 'mysql-community-server', question: 'mysql-community-server/re-root-pass', answer: "{{ mysql_root_password }}" }

- name: debconf status
  shell: 'debconf-get-selections | grep mysql'
  register: output
  become: true

- name: Debug debconf status
  vars:
    msg: |
      {{ output.stdout | trim }}
  debug:
    msg: "{{ msg.split('\n')[:-1] }}"

- name: Install MySQL (Debian)
  apt:
    package: mysql-server
    state: present
    force: true
  become: true
  register: mysql_install

- name: debconf status
  shell: 'debconf-get-selections | grep mysql'
  register: output
  become: true

- name: Debug debconf status
  vars:
    msg: |
      {{ output.stdout | trim }}
  debug:
    msg: "{{ msg.split('\n')[:-1] }}"

# - debug:
#     msg: "{{ mysql_install }}"

# - name: Share status
#   command: 'ls -la /usr/share/mysql-8.0/'
#   register: share

# - name: Debug share status
#   debug:
#     msg: "{{ share }}"

# - name: Service status
#   command: service mysql status
#   register: output

# - name: Debug service status
#   debug:
#     msg: "{{ output.stdout }}"

# - name: Ensure MySQL daemon is running (Debian)
#   service:
#     name: mysql
#     state: started
#     enabled: true
